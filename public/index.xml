<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Frank&#39;s Notes</title>
        <link>https://blog.yylin.io/</link>
        <description>Recent content on Frank&#39;s Notes</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-tw</language>
        <lastBuildDate>Thu, 30 Sep 2021 14:54:40 +0800</lastBuildDate><atom:link href="https://blog.yylin.io/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Red Hat OpenShift Platform on AWS (ROSA) 快速部署上手</title>
        <link>https://blog.yylin.io/p/redhat-aws-rosa/</link>
        <pubDate>Thu, 30 Sep 2021 14:54:40 +0800</pubDate>
        
        <guid>https://blog.yylin.io/p/redhat-aws-rosa/</guid>
        <description>&lt;h2 id=&#34;事前準備&#34;&gt;事前準備：&lt;/h2&gt;
&lt;p&gt;開始前，需要先準備以下資訊與要求。&lt;/p&gt;
&lt;h3 id=&#34;啟用-rosa&#34;&gt;啟用 ROSA&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;開始配置 AWS 服務前，使用者必須以 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/rosa/rosa_getting_started/rosa-aws-prereqs.html#rosa-policy-iam_prerequisites&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;IAM&lt;/a&gt; 身份(參考文件: &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/rosa/rosa_getting_started/rosa-aws-prereqs.html#rosa-customer-requirements_prerequisites&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Customer Requirements&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;登入 AWS 管理控制台，確認當前使用者&lt;code&gt;已啟用 Red Hat OpenShift&lt;/code&gt;服務
&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/lbpYgG6.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/lbpYgG6.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&#34;下載-aws-cli-與-openshift-cli-工具&#34;&gt;下載 AWS CLI 與 OpenShift CLI 工具:&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;URL Dowload&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;選擇當前環境下載對應&lt;code&gt;CLI&lt;/code&gt; ( &lt;a class=&#34;link&#34; href=&#34;https://console.redhat.com/openshift/downloads&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Command-line interface (CLI) tools&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/c64k4mB.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/c64k4mB.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Command Dowload&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下載 &lt;code&gt;AWS/OpenShift CLI&lt;/code&gt; 工具，並解壓縮檔案到 /usr/local/bin/ 底下:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# CLI&lt;/span&gt;
$ wget -c https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/rosa/latest/rosa-linux.tar.gz -O - &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; tar -xz
$ mv rosa /usr/local/bin/
$ rosa version
1.1.1

$ wget -c https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-4.8/openshift-client-linux.tar.gz -O - &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; tar -xz
$ mv &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;oc,kubectl&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt; /usr/local/bin/
$ oc version
Client Version: 4.8.2
$ oc version
Client Version: 4.8.10
Server Version: 4.8.12
Kubernetes Version: v1.21.1+d8043e1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;創建 Red Hat 帳號
OpenShift 由 Red Hat SaaS 提供，因此您需要創建一個 Red Hat 帳戶。
&lt;a class=&#34;link&#34; href=&#34;https://cloud.redhat.com/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://cloud.redhat.com/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h2 id=&#34;透過-rosa-指令檢查憑證與資源配置&#34;&gt;透過 ROSA 指令檢查憑證與資源配置&lt;/h2&gt;
&lt;p&gt;這邊以 Red Hat 部署 ROSA 文件部署為主 (&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/rosa/rosa_getting_started/rosa-creating-cluster.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Red Hat OpenShift Service on AWS - Creating a ROSA cluster&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;首先，使用 &lt;code&gt;ROSA CLI&lt;/code&gt; 檢查 AWS 憑證&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa verify permissions
I: Validating SCP policies...
I: AWS SCP policies ok
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;第一次登錄時，你會需要一個 Token 來登入你的 Red Hat 帳號&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;需要創建一組 Red Hat 帳號&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;確認登入訊息：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa login
I: Logged in as &lt;span class=&#34;s1&#34;&gt;&amp;#39;xxxx@mail.com&amp;#39;&lt;/span&gt; on &lt;span class=&#34;s1&#34;&gt;&amp;#39;https://api.openshift.com&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;配置完成後可以透過 &lt;code&gt;rosa whoami&lt;/code&gt; 來檢查你目前所有登錄憑證與狀態&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Red Hat 帳號會附帶 OpenShift Cluster Manager (OCM) 資訊與你的 AWS 帳戶顯示。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ rosa whoami
AWS Account ID:               xxxxxxxxxxxx
AWS Default Region:           us-west-2
AWS ARN:                      arn:aws:iam::xxxxxxxxxxxx:user/user
OCM API:                      https://api.openshift.com
OCM Account ID:               xxxxxxxxxxxxxxxxxxxxxx
OCM Account Name:             xxxxxx
OCM Account Username:         xxxxx@xxxxx.com
OCM Account Email:            xxxxx@xxxxx.com
OCM Organization ID:         xxxxxxxxxxxxxxxxxxxxxx
OCM Organization Name:        Red Hat
OCM Organization External ID: xxxxxxxx
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以上檢查沒問題後，接下運行 &lt;code&gt;rosa init&lt;/code&gt; 運行指令來確保 ROSA 配置與相關資源狀態沒問題&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ rosa init
I: Logged in as &#39;xxxxxx@mail.com&#39; on &#39;https://api.openshift.com&#39;
I: Validating AWS credentials...
I: AWS credentials are valid!
I: Validating SCP policies...
I: AWS SCP policies ok
I: Validating AWS quota...
I: AWS quota ok. If cluster installation fails, validate actual AWS resource usage against https://docs.openshift.com/rosa/rosa_getting_started/rosa-required-aws-service-quotas.html
I: Ensuring cluster administrator user &#39;osdCcsAdmin&#39;...
I: Admin user &#39;osdCcsAdmin&#39; already exists!
I: Validating SCP policies for &#39;osdCcsAdmin&#39;...
I: AWS SCP policies ok
I: Validating cluster creation...
I: Cluster creation valid
I: Verifying whether OpenShift command-line tool is available...
I: Current OpenShift Client Version: 4.8.10
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;需要驗證當前環境，是否已經登入 AWS並確認透過&lt;code&gt;rosa init&lt;/code&gt; 來確認 AWS 資源與配置是否能足夠創建 OpenShift&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;申請-aws-帳戶配額&#34;&gt;申請 AWS 帳戶配額&lt;/h3&gt;
&lt;p&gt;在配置 ROSA 時作為預先檢查 &lt;code&gt;$ rosa verify quota --region=${cluster}&lt;/code&gt; 叢集名稱。如果您在剛剛部署但未執行任何操作的帳戶上運行它，您將收到錯誤訊息 EC2 &lt;code&gt;quota 配置不足&lt;/code&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa verify quota --region&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;us-west-2
I: Validating AWS quota...
E: Insufficient AWS quotas
E: Service quota is insufficient &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the following service quota codes:
- Service ec2 quota code L-1216C47A Running On-Demand Standard &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;A, C, D, H, I, M, R, T, Z&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; instances not valid, expected quota of at least 100, but got &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;這邊需要額外申請 AWS EC2 限制增加配額
&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/X2PtefK.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/X2PtefK.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;需要提供申請需求與相關資訊，才能申請限制配額成功&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/fMprN3I.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/fMprN3I.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;相關配額資訊參考&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;AWS service quotas&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/rosa/rosa_getting_started/rosa-required-aws-service-quotas.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Required AWS service quotas&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/4K3BWLp.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/4K3BWLp.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以上完成申請後，再次驗證&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa verify quota --region&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;us-west-2
I: Validating AWS quota...
I: AWS quota ok. If cluster installation fails, validate actual AWS resource usage against https://docs.openshift.com/rosa/rosa_getting_started/rosa-required-aws-service-quotas.htm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id=&#34;透過-rosa-指令快速創建-red-hat-openshift&#34;&gt;透過 ROSA 指令快速創建 Red Hat OpenShift&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;透過 &lt;code&gt;rosa create cluster&lt;/code&gt; 開始部署 OpenShift Cluster (部署Cluster 大約需要30-40分鐘)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa create cluster --cluster-name&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;rosacluster
I: Creating cluster &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosacluster&amp;#39;&lt;/span&gt;
I: To view a list of clusters and their status, run &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosa list clusters&amp;#39;&lt;/span&gt;
I: Cluster &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosacluster&amp;#39;&lt;/span&gt; has been created.
I: Once the cluster is installed you will need to add an Identity Provider before you can login into the cluster. See &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosa create idp --help&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; more information.
I: To determine when your cluster is Ready, run &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosa describe cluster -c newsblogcluster&amp;#39;&lt;/span&gt;.
I: To watch your cluster installation logs, run &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosa logs install -c newsblogcluster --watch&amp;#39;&lt;/span&gt;.
Name:                       newsblogcluster
ID:                         XXXXXXXXXXXXXXXXXXXX
External ID:                
OpenShift Version:          
Channel Group:              stable
DNS:                        newsblogcluster.phnh.p1.openshiftapps.com
AWS Account:                &lt;span class=&#34;m&#34;&gt;123456789012&lt;/span&gt;
API URL:                    
Console URL:                
Region:                     xxxxxxxxxxx
Multi-AZ:                   &lt;span class=&#34;nb&#34;&gt;false&lt;/span&gt;
Nodes:
 - Master:                  &lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;
 - Infra:                   &lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;
 - Compute:                 &lt;span class=&#34;m&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;m5.xlarge&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
Network:
 - Service CIDR:            172.30.0.0/16
 - Machine CIDR:            10.0.0.0/16
 - Pod CIDR:                10.128.0.0/14
 - Host Prefix:             /23
State:                      pending &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Preparing account&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
Private:                    No
Created:                    xxxxxxxxxxxxxxxx
Details Page:               https://cloud.redhat.com/openshift/details/XXXXXXXXXXXXXXXXXXXX
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;執行命令後，您可以透過 &lt;code&gt;rosa describe cluster&lt;/code&gt; 或 &lt;code&gt;rosa logs install&lt;/code&gt; 指令檢查 OpenShift Cluster 狀態。您還可以從 URL 訪問 OpenShift Console 進行確認。&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/DvBaXFH.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/DvBaXFH.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;
&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/KkZJ3zn.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/KkZJ3zn.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/LUfY9n9.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/LUfY9n9.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ rosa create admin -c rosacluster
W: It is recommended to add an identity provider to login to this cluster. See &#39;rosa create idp --help&#39; for more information.
I: Admin account has been added to cluster &#39;rosacluster&#39;.
I: Please securely store this generated password. If you lose this password you can delete and recreate the cluster admin user.
I: To login, run the following command:

   oc login https://api.rosacluster.hffh.p1.openshiftapps.com:6443 --username cluster-admin --password fTwWy-rYJJU-wUua7-W3G6Z

I: It may take up to a minute for the account to become active.
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ oc login https://api.rosacluster.hffh.p1.openshiftapps.com:6443 --username cluster-admin --password fTwWy-rYJJU-wUua7-W3G6Z
Login successful.

You have access to &lt;span class=&#34;m&#34;&gt;87&lt;/span&gt; projects, the list has been suppressed. You can list all projects with &lt;span class=&#34;s1&#34;&gt;&amp;#39;oc projects&amp;#39;&lt;/span&gt;

Using project &lt;span class=&#34;s2&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ oc get no
NAME                                         STATUS   ROLES          AGE   VERSION
ip-10-0-153-95.us-west-2.compute.internal    Ready    worker         42m   v1.21.1+d8043e1
ip-10-0-171-119.us-west-2.compute.internal   Ready    infra,worker   17m   v1.21.1+d8043e1
ip-10-0-175-165.us-west-2.compute.internal   Ready    infra,worker   18m   v1.21.1+d8043e1
ip-10-0-202-234.us-west-2.compute.internal   Ready    master         49m   v1.21.1+d8043e1
ip-10-0-239-231.us-west-2.compute.internal   Ready    master         49m   v1.21.1+d8043e1
ip-10-0-242-134.us-west-2.compute.internal   Ready    master         49m   v1.21.1+d8043e1
ip-10-0-252-208.us-west-2.compute.internal   Ready    worker         42m   v1.21.1+d8043e1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;刪除-cluster&#34;&gt;刪除 Cluster&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;rosa delete cluster&lt;/code&gt; 可以使用指令刪除使用 ROSA 創建的cluster。順便說一下，集群的刪除在大約 10 分鐘內完成。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ rosa delete cluster --cluster&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;rosacluster
? Are you sure you want to delete cluster rosacluster? Yes
I: Cluster &lt;span class=&#34;s1&#34;&gt;&amp;#39;rosacluster&amp;#39;&lt;/span&gt; will start uninstalling now
I: To watch your cluster uninstallation logs, run &lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;rosa logs uninstall -c rosacluster --watch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;reference&#34;&gt;Reference&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;rosaworkshop.io&#34; &gt;Red Hat OpenShift Service on AWS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        <item>
        <title>OpenShift Intsall Troubleshooting Notes</title>
        <link>https://blog.yylin.io/p/openshift-intsall-troubleshooting-notes/</link>
        <pubDate>Wed, 29 Sep 2021 00:53:25 +0800</pubDate>
        
        <guid>https://blog.yylin.io/p/openshift-intsall-troubleshooting-notes/</guid>
        <description>&lt;p&gt;延伸上一篇 OCP UPI 部署(&lt;a class=&#34;link&#34; href=&#34;https://blog.yylin.io/p/openshift-4.8.x-upi-install-on-bare-metal&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;OpenShift 4.8.x UPI install on Bare metal&lt;/a&gt;)過程遇到問題彙整。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;備註: 由於資源有限情況下，透過單一伺服器(主機)透過 VM 模擬實際節點硬體資源環境，這邊主要透過檢測與除錯，來確保 OpenShift 部署成功。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;部署常見問題整理-持續更新&#34;&gt;部署常見問題整理 (持續更新)&lt;/h2&gt;
&lt;h3 id=&#34;超時等待-bootstrap-節點啟動&#34;&gt;超時等待 &lt;code&gt;bootstrap&lt;/code&gt; 節點啟動&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;發現特定 Pod 持續&lt;code&gt;RunningNotReady&lt;/code&gt; 狀態&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-bash=&#34; data-lang=&#34;bash=&#34;&gt;W0830 11:16:37.087497   35214 reflector.go:436] k8s.io/client-go/tools/watch/informerwatcher.go:146: watch of *v1.ConfigMap ended with: very short watch: k8s.io/client-go/tools/watch/informerwatcher.go:146: Unexpected watch close - watch lasted less than a second and no items received
apiserver - &amp;gt; RunningNotReady
Aug 30 03:42:37 bootstrap.lab.yiylin.internal bootkube.sh[644199]:         Pod Status:openshift-kube-apiserver/kube-apiserver        RunningNotReady
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;此情境請透過收集&lt;code&gt;bootstrap&lt;/code&gt; 節點日誌，來確認環境問題&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ./openshift-install gather bootstrap --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;lt;installation_directory&amp;gt; 
...
INFO Pulling debug logs from the bootstrap machine
INFO Bootstrap gather logs captured here &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;lt;installation_directory&amp;gt;/log-bundle-&amp;lt;timestamp&amp;gt;.tar.gz&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;蒐集包含 bootstrap process / bootstrap 上所有 Pod/Container 的 log&lt;/li&gt;
&lt;li&gt;下載完後解壓縮 &lt;code&gt;.tar.gz&lt;/code&gt; 檔案，針對可能部署或未啟動的&lt;code&gt;Pod&lt;/code&gt;檢查log錯誤狀態，來找到對應的錯誤資訊&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;補充說明 bootstrap 主要分成兩個動作&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;安裝自己跟建立自己的 cluster(Pod)&lt;/li&gt;
&lt;li&gt;引導安裝 master x 3&lt;/li&gt;
&lt;li&gt;master bootstrap 全部安裝完，然後下 wait for complete 確認最終才可移除 bootstrap node&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;reference&#34;&gt;Reference:&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing-troubleshooting.html#installation-bootstrap-gather_installing-troubleshooting&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Gathering logs from a failed installation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_bare_metal/installing-bare-metal.html#installation-installing-bare-metal_installing-bare-metal&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Waiting for the bootstrap process to complete&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;master-node-部署不起來檢查並驗證-etcd-運行之硬碟是否正常運作-&#34;&gt;Master Node 部署不起來，檢查並驗證 etcd 運行之硬碟是否正常運作 ?&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;大部分 master 無法建置情境，通常可能會有原因是硬碟速度問題(硬碟壞軌)&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;造成叢集有時候部署成功有時候會失敗的情況&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;透過簡單運行 &lt;code&gt;fio&lt;/code&gt; 來測試 etcd benchamrk performance 檢測&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ oc debug node/&amp;lt;master_node&amp;gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;...&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
sh-4.4# chroot /host bash
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@&amp;lt;master_node&amp;gt; /&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# podman run --volume /var/lib/etcd:/var/lib/etcd:Z quay.io/openshift-scale/etcd-perf&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;reference-1&#34;&gt;Reference:&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://access.redhat.com/solutions/4885641&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;How to Use &amp;lsquo;fio&amp;rsquo; to Check Etcd Disk Performance in OCP
&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://www.youtube.com/watch?v=6qjsh9J3ndM&amp;amp;ab_channel=PingChunHuang&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;[參考影片說明] OpenShift 4 如何使用 fio 驗證 etcd 運行之硬碟是否可以正常運作 / Use &amp;lsquo;fio&amp;rsquo; to Check Etcd Disk Performance&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://www.ibm.com/docs/en/cloud-private/3.2.x?topic=requirements-hardware-recommendations&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Hardware requirements and recommendations&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;補充檢查---除錯流程&#34;&gt;補充|檢查 - 除錯流程&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;部署過程都透過 bootkube 確認部署狀態資訊，log 會不斷顯示錯誤然後 loop 確認環節，嘗試能不能從他錯誤訊息找出規則(也就是他跳錯誤的地方，通常是在 log restart之前)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;嘗試 SSH 到 Master Node，透過 &lt;code&gt;netstat -plnt&lt;/code&gt; 檢查三個服務，這三個通常只要好，這台 Master 就沒問題 (6443| 22623|2379|2380)，分別是 OpenShift API/Kubernetes API/ETCD/Machine Config Operator&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果以上幾個 Pod 有問題，透過 &lt;code&gt;crictl ps&lt;/code&gt; 跟 &lt;code&gt;crictl log&lt;/code&gt; 去查看 Container Log，問題有可能是連續的錯誤，所以可能是 API 有問題，可能是 Controller/Scheduler 引起，細節需要透過上面提到方式，下載節點所有 Log 日誌來比對檢查，找到正確的錯誤資訊來排除錯誤&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;reference-2&#34;&gt;Reference:&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://connect.redhat.com/en/blog/openshift-troubleshooting-resources&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;OpenShift Troubleshooting Resources&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        <item>
        <title>OpenShift 4.8.x UPI install on Bare metal</title>
        <link>https://blog.yylin.io/p/openshift-4.8.x-upi-install-on-bare-metal/</link>
        <pubDate>Sun, 26 Sep 2021 14:54:40 +0800</pubDate>
        
        <guid>https://blog.yylin.io/p/openshift-4.8.x-upi-install-on-bare-metal/</guid>
        <description>&lt;blockquote&gt;
&lt;p&gt;[註記] 由於硬體環境資源有限，本實驗是透過 &lt;a class=&#34;link&#34; href=&#34;https://pve.proxmox.com/wiki/Main_Page&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;&lt;code&gt;Proxmox Environment&lt;/code&gt;&lt;/a&gt; 單一伺服器節點來模擬部署 &lt;code&gt;OpenShift&lt;/code&gt; 叢集，並依據官網配置建議硬體需求(Server sizing)資源。
[共同撰寫編輯]: &lt;a class=&#34;link&#34; href=&#34;https://k2r2bai.com/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Kyle Bai&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;部署版本說明&#34;&gt;部署版本說明：&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Proxmox Environment v6.1-7
&lt;ul&gt;
&lt;li&gt;CPU: 8-Core, 16-Thread Unlocked / Memory: 128 GB&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;OpenShift v4.8.x.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;reference&#34;&gt;Reference&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;參考官網文件 - &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_bare_metal/installing-bare-metal.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Installing a user-provisioned cluster on bare metal&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;事前準備&#34;&gt;事前準備&lt;/h2&gt;
&lt;p&gt;開始前，需要先準備以下資訊與要求。&lt;/p&gt;
&lt;h3 id=&#34;download-urls&#34;&gt;Download URLs&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://console.redhat.com/openshift/install/metal/user-provisioned&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;User-provisioned infrastructure&lt;/a&gt;: 可下載 OpenShift Installer、CLI 與 Pull secrets(需要登入 Red Hat 註冊帳號權限)&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-4.8/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Public OpenShift 4.8 Mirror&lt;/a&gt;: 可下載 OpenShift Installer、CLI 與 OPM。
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;openshift-client-linux.tar.gz&lt;/strong&gt;: 包含 oc 與 kubectl CLI 工具。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;openshift-install-linux.tar.gz&lt;/strong&gt;: 包含 openshift-install 工具。用於建立 OpenShift auth、igntion 等設定檔案。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;opm-linux.tar.gz&lt;/strong&gt;: 用於管理 Operator Hub 與 mirror 相關 images。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.8/latest/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Public RHCOS 4.8 Mirror&lt;/a&gt;: 可下載 RHCOS 4.8 相關 VM images。
&lt;ul&gt;
&lt;li&gt;若手動安裝以下載 &lt;code&gt;rhcos-live.x86_64.iso&lt;/code&gt; 為主。若想要控管使用版本，請選擇有標示版本的 live iso。
&lt;ul&gt;
&lt;li&gt;FET vSphere 安裝請以這方式進行。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;若以 PXE 方式安裝，則下載以下映像檔:
&lt;ul&gt;
&lt;li&gt;rhcos-live-initramfs.x86_64.img&lt;/li&gt;
&lt;li&gt;rhcos-live-kernel-x86_64&lt;/li&gt;
&lt;li&gt;rhcos-live-rootfs.x86_64.img&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;過程中會透過 &lt;code&gt;wget&lt;/code&gt; 下載，因此在有網路狀況下，不需要預先下載。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h3 id=&#34;network-and-hosts-info&#34;&gt;Network and Hosts Info&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;OpenShift subnet CIDR&lt;/strong&gt;: 192.168.101.0/24&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;OpenShift Pod Network(CNI)&lt;/strong&gt;: 10.128.0.0/14&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;OpenShift Service Network&lt;/strong&gt;: 172.3.0.0/16&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Domain&lt;/strong&gt;: lab.yiylin.internal&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Hosts&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;CPU&lt;/th&gt;
&lt;th&gt;RAM&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;bashtion&lt;/td&gt;
&lt;td&gt;192.168.101.9&lt;/td&gt;
&lt;td&gt;2 vCore&lt;/td&gt;
&lt;td&gt;4G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bootstrap&lt;/td&gt;
&lt;td&gt;192.168.101.10&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master-1&lt;/td&gt;
&lt;td&gt;192.168.101.21&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master-2&lt;/td&gt;
&lt;td&gt;192.168.191.22&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master-3&lt;/td&gt;
&lt;td&gt;192.168.191.23&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;worker-1&lt;/td&gt;
&lt;td&gt;192.168.191.31&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;worker-2&lt;/td&gt;
&lt;td&gt;192.168.191.32&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;infra-1&lt;/td&gt;
&lt;td&gt;192.168.191.41&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;infra-2&lt;/td&gt;
&lt;td&gt;192.168.191.42&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;infra-3&lt;/td&gt;
&lt;td&gt;192.168.191.43&lt;/td&gt;
&lt;td&gt;4 vCore&lt;/td&gt;
&lt;td&gt;8G&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;這裡為了方便測試，將 PXE / HAProxy / DNS Server 等都放在 bastion上。
[額外參考資訊]各元件節點最小資源可參考 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_platform_agnostic/installing-platform-agnostic.html#minimum-resource-requirements_installing-platform-agnostic&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Minimum resource requirements&lt;/a&gt;。
請先透過 &lt;code&gt;Proxmox Environment&lt;/code&gt; 開啟對應 &lt;code&gt;hardware&lt;/code&gt; VM。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;補充-network-說明&#34;&gt;補充 Network 說明&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;其中 &lt;code&gt;OpenShift subnet CIDR&lt;/code&gt; 請修改為自己當前 Proxmox Environment 網路配置)
&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/8UnOcXL.jpg&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/8UnOcXL.jpg&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;bastion&#34;&gt;Bastion&lt;/h2&gt;
&lt;p&gt;透過 Live CD 安裝 RHEL 8 版本(或使用 CentOS 8)，並確保網路設定正確。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;RHEL 需要確認 &lt;code&gt;subscription&lt;/code&gt; 驗證，確保 repo 源可正常取得&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;事前準備-1&#34;&gt;事前準備&lt;/h3&gt;
&lt;p&gt;進入 &lt;code&gt;bastion&lt;/code&gt; 機器，安裝 jq 與 wget 工具等:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ sudo su -
$ yum install -y wget jq vim
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;關閉 bastion 防火牆:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ systemctl stop firewalld
$ systemctl disable firewalld
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&amp;gt; 這邊方便測試，所以直接關閉 :D。&lt;/p&gt;
&lt;p&gt;設定與關閉 SELinux:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ vim /etc/selinux/config
&lt;span class=&#34;nv&#34;&gt;SELINUX&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;disabled

$ setenforce &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;這邊方便測試實驗，所以直接關閉。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;建立 SSH Keys:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ ssh-keygen -t rsa
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;這邊方便測試，以 root 來建立。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;導入以下環境變數:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;lab.yiylin.internal
&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;OCP_NETWORK_CIDR&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;192.168.101.0/24 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;下載 OpenShift Installer 與 CLI 工具，並解壓縮檔案到 &lt;code&gt;/usr/local/bin/&lt;/code&gt; 底下:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# CLI&lt;/span&gt;
$ wget -c https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-4.8/openshift-client-linux.tar.gz -O - &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; tar -xz
$ mv &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;oc,kubectl&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt; /usr/local/bin/
$ oc version
Client Version: 4.8.2

&lt;span class=&#34;c1&#34;&gt;# Installer&lt;/span&gt;
$ wget -c https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-4.8/openshift-install-linux.tar.gz -O - &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; tar -xz
$ mv openshift-install /usr/local/bin/
$ openshift-install version
openshift-install 4.8.2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;安裝與設定-dns-server&#34;&gt;安裝與設定 DNS Server&lt;/h3&gt;
&lt;p&gt;安裝 DNS server 套件，這邊使用 &lt;code&gt;dnsmasq&lt;/code&gt; 來提供服務:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ yum -y install dnsmasq bind-utils
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;這部分也可參考 OCP 官網安裝 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_bare_metal/installing-bare-metal.html#installation-dns-user-infra-example_installing-bare-metal&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;BIND&lt;/a&gt;，關於不同 &lt;code&gt;DNS Server&lt;/code&gt; 相關配置方法，會額外補充於後續文章介紹。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;編輯 &lt;code&gt;/etc/dnsmasq.d/openshift.conf&lt;/code&gt; 設定檔，以設定 A Record 與 PTR:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cat &amp;lt;&amp;lt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;EOF&amp;#34;&lt;/span&gt; &amp;gt; /etc/dnsmasq.d/openshift.conf
&lt;span class=&#34;nv&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;8.8.8.8

&lt;span class=&#34;nv&#34;&gt;domain&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;OCP_NETWORK_CIDR&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,local

&lt;span class=&#34;c1&#34;&gt;# A Records(api)&lt;/span&gt;
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;api.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;, 192.168.101.9
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;api-int.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;api-int.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.9

&lt;span class=&#34;c1&#34;&gt;# A Records(hosts)&lt;/span&gt;
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;bastion.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.9
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;bootstrap.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.10
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;master-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.21
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;master-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.22
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;master-3.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.23
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;worker-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.31
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;worker-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.32
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;infra-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.41
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;infra-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.42
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;infra-3.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.43

&lt;span class=&#34;c1&#34;&gt;# A Records(etcd)&lt;/span&gt;
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;etcd-0.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.21
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;etcd-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.22
host-record&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;etcd-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,192.168.101.23

srv-host&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;_etcd-server-ssl._tcp.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,etcd-0.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,2380,0,10
srv-host&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;_etcd-server-ssl._tcp.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,etcd-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,2380,0,10
srv-host&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;_etcd-server-ssl._tcp.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,etcd-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;,2380,0,10

&lt;span class=&#34;c1&#34;&gt;# PTRs&lt;/span&gt;
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/apps.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.9
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/.apps.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.9
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/api.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.9
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/api-int.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.9
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/bastion.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.9
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/bootstrap.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.10
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/master-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.21
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/master-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.22
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/master-3.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.23
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/etcd-0.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.21
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/etcd-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.22
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/etcd-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.23
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/worker-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.31
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/worker-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.32
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/infra-1.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.41
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/infra-2.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.42
&lt;span class=&#34;nv&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/infra-3.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;/192.168.101.43
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;啟動 dnsmasq 服務，並檢測 dnsmasq 設定是否正確:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ systemctl &lt;span class=&#34;nb&#34;&gt;enable&lt;/span&gt; dnsmasq&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; systemctl start dnsmasq
$ dnsmasq --test
dnsmasq: syntax check OK.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;編輯 &lt;code&gt;/etc/resolv.conf&lt;/code&gt; 檔案，修改 nameserver:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cat &amp;lt;&amp;lt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;EOF&amp;#34;&lt;/span&gt; &amp;gt; /etc/resolv.conf
nameserver 127.0.0.1
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;驗證 DNS server 正反解:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# dig domain @dns_server&lt;/span&gt;
$ dig bastion.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; @192.168.101.9

&lt;span class=&#34;c1&#34;&gt;# dig -x ip @dns_server&lt;/span&gt;
$ dig -x 192.168.101.9 @192.168.101.9
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;請驗證填寫自己對應的 &lt;code&gt;ip address&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;安裝與設定-http-server&#34;&gt;安裝與設定 HTTP Server&lt;/h3&gt;
&lt;p&gt;安裝與設定 httpd 套件:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ yum -y install httpd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;編輯 &lt;code&gt;/etc/httpd/conf/httpd.conf&lt;/code&gt; 設定檔:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;c1&#34;&gt;#Listen 12.34.56.78:80&lt;/span&gt;
Listen 8080	
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;因為 80 是 Ingress-http 使用，除非將 HAProxy 拆成不同節點或用 External LB。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;啟動 httpd 服務:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ systemctl &lt;span class=&#34;nb&#34;&gt;enable&lt;/span&gt; httpd&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; systemctl start httpd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;產生-openshift-ignition-fils&#34;&gt;產生 OpenShift Ignition fils&lt;/h3&gt;
&lt;p&gt;建立放置 OpenShift Config 檔案的目錄:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ &lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; mkdir &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;建立與編輯 &lt;code&gt;install-config.yaml&lt;/code&gt; 檔案:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;v1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;baseDomain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;yiylin.internal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;compute&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;hyperthreading&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;Enabled&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;worker&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;replicas&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;controlPlane&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;hyperthreading&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;Enabled&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;master&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;replicas&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;lab&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;networking&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;clusterNetworks&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;cidr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;10.128.0.0&lt;/span&gt;&lt;span class=&#34;l&#34;&gt;/14&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;hostPrefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;networkType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;OpenShiftSDN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;serviceNetwork&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;m&#34;&gt;172.3.0.0&lt;/span&gt;&lt;span class=&#34;l&#34;&gt;/16&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;platform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;none&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;pullSecret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{&amp;#34;auths&amp;#34;:{ YOUR_PULL_SECRETE }}&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;sshKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SSH_PUB_KEY&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Pull secret 可在 &lt;a class=&#34;link&#34; href=&#34;https://cloud.redhat.com/openshift/install/metal/user-provisioned&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Create Cluster by user provisioned&lt;/a&gt; 取得。&lt;/li&gt;
&lt;li&gt;Proxy 設定，參考 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_bare_metal/installing-restricted-networks-bare-metal.html#installation-configure-proxy_installing-restricted-networks-bare-metal&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Configuring the cluster-wide proxy during installation&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;SSH Key 請自行於 &lt;code&gt;bastion&lt;/code&gt; 創建填寫，這裡不多做說明&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;產生 manifests 相關檔案:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cp install-config.yaml install-config.yaml.bak
$ openshift-install create manifests --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition
$ ls &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition
manifests  openshift
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;編輯 &lt;code&gt;manifests/cluster-scheduler-02-config.yml&lt;/code&gt; 檔案，設定 &lt;code&gt;mastersSchedulable&lt;/code&gt; 值，以確保 master 不作為工作負載節點:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;nn&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;mastersSchedulable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nn&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;產生 OCP 使用的 Ignition files:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ openshift-install create ignition-configs --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition
$ ls &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition
auth  bootstrap.ign  master.ign  metadata.json  worker.ign
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;撰寫方面安裝 RHCOS 的腳本 &lt;code&gt;$HOME/ocp4/ignition/coreos-install.sh&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#!/bin/bash
&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; -eu 

&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;DEVICE_NAME&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DEVICE_NAME&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;:-&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;/dev/sda&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;IGNITION_FILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;IGNITION_FILE&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;:-&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;bootstrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.ign&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# bootstrap.ign  master.ign  worker.ign &lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;IGNITION_URL&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;IGNITION_URL&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;:-&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;://192.168.101.9:&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;8080&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;/ignition/&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;IGNITION_FILE&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}}&lt;/span&gt;

sudo coreos-installer install &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DEVICE_NAME&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --insecure-ignition &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --ignition-url&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;IGNITION_URL&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --firstboot-args rd.neednet&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --copy-network
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;複製 &lt;code&gt;*.ign&lt;/code&gt; 與腳本 到 &lt;code&gt;/var/www/html/ignition&lt;/code&gt; 目錄:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ mkdir /var/www/html/ignition
$ cp -rp &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition/&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;*.ign,coreos-install.sh&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt; /var/www/html/ignition
$ ls /var/www/html/ignition
bootstrap.ign  master.ign  worker.ign coreos-install.sh

$ chmod &lt;span class=&#34;m&#34;&gt;664&lt;/span&gt; -R /var/www/html/ignition/*
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;bootstrap&#34;&gt;Bootstrap&lt;/h2&gt;
&lt;p&gt;透過 PVE 建立 Bootstrap 節點，並掛載 RHCOS Live ISO，並進入 Console 執行以下操作。&lt;/p&gt;
&lt;p&gt;首先進入系統後，先設定 Network 資訊:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ sudo nmtui
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;設定網卡資訊:&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/tJFSkiO.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/tJFSkiO.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/vAEtA2f.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/vAEtA2f.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/qINQqLa.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/qINQqLa.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;確保網卡 IP address 設定為 &lt;code&gt;xx.xx.xx.xx/24&lt;/code&gt;，若沒有設定 Network mask 的話，就會用預設 &lt;code&gt;xx.xx.xx.xx/8&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;重新啟動網卡設定:&lt;/p&gt;
&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/KMvs0UZ.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/KMvs0UZ.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;透過以下指令檢查設定結果:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ ip -4 a
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;確認網路與 DNS 都能夠被解析到。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;確認沒問題後，執行以下指令來安裝 RHCOS，並設定為 Bootstrap 節點:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ curl http://192.168.101.9:8080/ignition/coreos-install.sh --output coreos-install.sh
$ chmod u+x coreos-install.sh
$ ./coreos-install.sh

&lt;span class=&#34;c1&#34;&gt;# 安裝完成後&lt;/span&gt;
$ lsblk -f
$ reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;安裝沒問題後，重新啟動機器，並將 CD-ROM 移除。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Bootstrap 開啟完成後，回到 &lt;code&gt;bastion&lt;/code&gt; 節點執行以下指令來檢查部署狀況:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ openshift-install wait-for bootstrap-complete --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition --log-level debug
DEBUG OpenShift Installer 4.8.2
DEBUG Built from commit a5ddd2dd6c72d8a5ea0a5f17acd8b964b6a3d1be
INFO Waiting up to 20m0s &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the Kubernetes API at https://api.lab.yiylin.internal:6443...
INFO API v1.21.1+051ac4f up
INFO Waiting up to 30m0s &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; bootstrapping to complete...

&lt;span class=&#34;c1&#34;&gt;# 確認 openshift-api-server 以及 machine-config-server LB 可以通&lt;/span&gt;
$ curl -k https://api-int.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;:6443
$ curl -k https://api-int.&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;DOMAIN&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;:22623/config/master &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; jq .
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;當看到此訊息時，就能並往下進行安裝 Masters。若等待過久，可以透過 bastion 進入 bootstrap 節點查看狀況:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ ssh core@bootstrap.lab.yiylin.internal

core $ sudo crictl pods
core $ sudo crictl ps -a
core $ sudo journalctl -b -f -u bootkube.service
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;正常情況 Pods 要如以下:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;POD ID              CREATED              STATE               NAME                                           NAMESPACE                             ATTEMPT             RUNTIME
8101e41b16f9e       52 seconds ago       Ready               bootstrap-kube-scheduler-localhost             kube-system                           0                   (default)
907d0a933771a       52 seconds ago       Ready               bootstrap-kube-controller-manager-localhost    kube-system                           0                   (default)
a8b709f7caeaa       52 seconds ago       Ready               bootstrap-kube-apiserver-localhost             kube-system                           0                   (default)
4eb793b3d1844       52 seconds ago       Ready               cloud-credential-operator-localhost            openshift-cloud-credential-operator   0                   (default)
49a1cdb2b25f9       52 seconds ago       Ready               bootstrap-cluster-version-operator-localhost   openshift-cluster-version             0                   (default)
c5098e42b5aa5       About a minute ago   Ready               bootstrap-machine-config-operator-localhost    default                               0                   (default)
e7a3dbc6e0bc0       About a minute ago   Ready               etcd-bootstrap-member-localhost                openshift-etcd                        0                   (default)
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;maters&#34;&gt;Maters&lt;/h2&gt;
&lt;p&gt;透過 vCenter 建立 Master 節點，並掛載 RHCOS Live ISO，並進入 Console 執行以下操作。&lt;/p&gt;
&lt;p&gt;首先進入系統後，先設定 Network 資訊:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ sudo nmtui
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&amp;gt; 網路參考 Bootstrap 設定流程。&lt;/p&gt;
&lt;p&gt;確認沒問題後，執行以下指令來安裝 RHCOS，並設定為 Masters 節點:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ curl http://192.168.101.9:8080/ignition/coreos-install.sh --output coreos-install.sh
$ chmod u+x coreos-install.sh
$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;IGNITION_FILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;master.ign
$ ./coreos-install.sh

&lt;span class=&#34;c1&#34;&gt;# 安裝完後&lt;/span&gt;
$ reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;安裝沒問題後，重新啟動機器，並將 CD-ROM 移除。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Masters 都開啟完成後，回到 &lt;code&gt;bastion&lt;/code&gt; 節點執行以下指令來檢查部署狀況:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ openshift-install wait-for bootstrap-complete --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition --log-level debug
...
INFO Waiting up to 30m0s &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; bootstrapping to complete...
DEBUG Bootstrap status: &lt;span class=&#34;nb&#34;&gt;complete&lt;/span&gt;
INFO It is now safe to remove the bootstrap resources
INFO Time elapsed: 0s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 &lt;code&gt;bastion&lt;/code&gt; 執行以下指令來查看叢集狀況:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cp &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition/auth/kubeconfig &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/kubeconfig
$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;KUBECONFIG&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/kubeconfig
$ oc get csr
NAME                                       AGE   SIGNERNAME                                    REQUESTOR                                                                         CONDITION
csr-9xqqd                                  25m   kubernetes.io/kubelet-serving                 system:node:etcd-1                                                                Approved,Issued
csr-gzvwr                                  27m   kubernetes.io/kubelet-serving                 system:node:etcd-0                                                                Approved,Issued
csr-j6npt                                  25m   kubernetes.io/kubelet-serving                 system:node:etcd-2                                                                Approved,Issued
csr-mxqkf                                  25m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         Approved,Issued
csr-tth9f                                  28m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         Approved,Issued
csr-zx9q8                                  25m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         Approved,Issued
system:openshift:openshift-authenticator   25m   kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-authentication-operator:authentication-operator   Approved,Issued

$ oc get no
NAME                           STATUS   ROLES    AGE   VERSION
master-1.lab.yiylin.internal   Ready    master   31m   v1.21.1+051ac4f
master-2.lab.yiylin.internal   Ready    master   15m   v1.21.1+051ac4f
master-3.lab.yiylin.internal   Ready    master   10m   v1.21.1+051ac4f
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;完成後，即可進行 Workers 與 Infras 部署，並移除 Bootstrap。若等待過久，可以透過 bastion 進入 masters 節點查看狀況:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ ssh core@maste-1.lab.yiylin.internal
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;workers-amp-infras&#34;&gt;Workers &amp;amp; Infras&lt;/h2&gt;
&lt;p&gt;透過 vCenter 建立 Workers &amp;amp; Infras 節點，並掛載 RHCOS Live ISO，並進入 Console 執行以下操作。&lt;/p&gt;
&lt;p&gt;首先進入系統後，先設定 Network 資訊:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ sudo nmtui
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;網路參考 Bootstrap 設定流程。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;確認沒問題後，執行以下指令來安裝 RHCOS，並設定為 Workers &amp;amp; Infras 節點:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ curl http://192.168.101.9:8080/ignition/coreos-install.sh --output coreos-install.sh
$ chmod u+x coreos-install.sh
$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;IGNITION_FILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;worker.ign
$ ./coreos-install.sh

&lt;span class=&#34;c1&#34;&gt;# 安裝完成後&lt;/span&gt;
$ lsblk -f
$ reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;安裝沒問題後，重新啟動機器，並將 CD-ROM 移除。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Workers &amp;amp; Infras 都開啟完成後，就可以回到 &lt;code&gt;bastion&lt;/code&gt; 節點執行以下指令來檢查部署狀況:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ openshift-install wait-for install-complete --dir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition --log-level debug
DEBUG OpenShift Installer 4.8.2
DEBUG Built from commit a5ddd2dd6c72d8a5ea0a5f17acd8b964b6a3d1be
DEBUG Loading Install Config...
DEBUG   Loading SSH Key...
DEBUG   Loading Base Domain...
DEBUG     Loading Platform...
DEBUG   Loading Cluster Name...
DEBUG     Loading Base Domain...
DEBUG     Loading Platform...
DEBUG   Loading Networking...
DEBUG     Loading Platform...
DEBUG   Loading Pull Secret...
DEBUG   Loading Platform...
DEBUG Using Install Config loaded from state file
INFO Waiting up to 40m0s &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the cluster at https://api.lab.yiylin.internal:6443 to initialize...
DEBUG Still waiting &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the cluster to initialize: Some cluster operators are still updating: authentication, console, ingress, monitoring
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;出現 &lt;code&gt;DEBUG&lt;/code&gt; 即可往下操作，因為這部分會需要下載 Images 會比較久&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;開啟一個新的 Terminal，在 &lt;code&gt;bastion&lt;/code&gt; 節點 Approve workers CSR:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;KUBECONFIG&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/kubeconfig
$ oc get csr -ojson &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; jq -r .items&lt;span class=&#34;o&#34;&gt;[]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;.status &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;{}&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; .metadata.name &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; xargs oc adm certificate approve

&lt;span class=&#34;c1&#34;&gt;# 確認機器都起來&lt;/span&gt;
$ oc get no
NAME       STATUS   ROLES    AGE   VERSION
infra0     Ready    worker   12m   v1.21.1+051ac4f
infra1     Ready    worker   12m   v1.21.1+051ac4f
infra2     Ready    worker   12m   v1.21.1+051ac4f
master0    Ready    master   11h   v1.21.1+051ac4f
master1    Ready    master   11h   v1.21.1+051ac4f
master2    Ready    master   11h   v1.21.1+051ac4f
worker0    Ready    worker   12m   v1.21.1+051ac4f
worker1    Ready    worker   12m   v1.21.1+051ac4f
worker2    Ready    worker   12m   v1.21.1+051ac4f
worker3    Ready    worker   12m   v1.21.1+051ac4f
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;搬移資源至-infra-nodes&#34;&gt;搬移資源至 Infra nodes&lt;/h3&gt;
&lt;p&gt;接著要將 Worker 與 Infra 角色做拆分，確保系統與 Operator 服務不影響業務服務的負載，參考 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/machine_management/creating-infrastructure-machinesets.html#infrastructure-components_creating-infrastructure-machinesets&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Creating infrastructure machine sets&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;設定 infra nodes 的 labels:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; i in &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;1..2&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
  oc label node worker-&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; node-role.kubernetes.io/app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; --overwrite
&lt;span class=&#34;k&#34;&gt;done&lt;/span&gt;

$ &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; i in &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;1..3&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    oc label node infra-&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; node-role.kubernetes.io/infra&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; --overwrite
    oc label node infra-&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; node-role.kubernetes.io/worker-
  &lt;span class=&#34;k&#34;&gt;done&lt;/span&gt;

$ oc get no
NAME                           STATUS   ROLES        AGE    VERSION
infra-1.lab.yiylin.internal    Ready    infra        31m    v1.21.1+051ac4f
infra-2.lab.yiylin.internal    Ready    infra        31m    v1.21.1+051ac4f
infra-3.lab.yiylin.internal    Ready    infra        31m    v1.21.1+051ac4f
master-1.lab.yiylin.internal   Ready    master       156m   v1.21.1+051ac4f
master-2.lab.yiylin.internal   Ready    master       140m   v1.21.1+051ac4f
master-3.lab.yiylin.internal   Ready    master       135m   v1.21.1+051ac4f
worker-1.lab.yiylin.internal   Ready    app,worker   31m    v1.21.1+051ac4f
worker-2.lab.yiylin.internal   Ready    app,worker   31m    v1.21.1+051ac4f
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;編輯 &lt;code&gt;Scheduler&lt;/code&gt; 物件，並調整預設 &lt;code&gt;NodeSelector&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ oc edit scheduler cluster
...
spec:
  defaultNodeSelector: node-role.kubernetes.io/app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;建立 Infra 機器的 Machine Config Pool 檔案:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cat &lt;span class=&#34;p&#34;&gt;&amp;amp;&lt;/span&gt;lt&lt;span class=&#34;p&#34;&gt;;&amp;amp;&lt;/span&gt;lt&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;EOF &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; oc apply -f -
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: infra
spec:
  machineConfigSelector:
    matchExpressions:
    - key: machineconfiguration.openshift.io/role
      operator: In
      values:
      - worker
      - infra
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/infra:
EOF

$ oc get mcp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;這時 Infra 節點會重新啟動。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;搬移 Router 元件至 Infra 節點上:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ oc edit IngressController default -n openshift-ingress-operator
...
spec:
  nodePlacement:
    nodeSelector:
      matchLabels:
        node-role.kubernetes.io/infra:
  replicas: &lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;
  
$ oc -n openshift-ingress get pod -o wide
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;搬移 Image Registry 元件至 Infra 節點上:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ oc edit configs.imageregistry.operator.openshift.io/cluster
...
spec:
  nodeSelector:
    node-role.kubernetes.io/infra:
...

$ oc -n openshift-image-registry get pods -o wide 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;搬移 Monitoring 元件至 Infra 節點上:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cat &amp;lt;&amp;lt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;EOF&amp;#34;&lt;/span&gt; &amp;gt; oc apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;+
    alertmanagerMain:
      nodeSelector:
        node-role.kubernetes.io/infra:
    prometheusK8s:
      nodeSelector:
        node-role.kubernetes.io/infra:
    prometheusOperator:
      nodeSelector:
        node-role.kubernetes.io/infra:
    grafana:
      nodeSelector:
        node-role.kubernetes.io/infra:
    k8sPrometheusAdapter:
      nodeSelector:
        node-role.kubernetes.io/infra:
    kubeStateMetrics:
      nodeSelector:
        node-role.kubernetes.io/infra:
    telemeterClient:
      nodeSelector:
        node-role.kubernetes.io/infra:
    openshiftStateMetrics:
      nodeSelector:
        node-role.kubernetes.io/infra:
    thanosQuerier:
      nodeSelector:
        node-role.kubernetes.io/infra:
EOF

$ watch -n 0.1 oc -n openshift-monitoring get pod -o wide
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&amp;gt; 其他資源請參考 &lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/machine_management/creating-infrastructure-machinesets.html#infrastructure-moving-logging_creating-infrastructure-machinesets&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Moving OpenShift Logging resources&lt;/a&gt; 搬移。&lt;/p&gt;
&lt;p&gt;叢集初始化會需要一點時間，完成後就可以透過 Console 查看整體狀況。&lt;/p&gt;
&lt;h2 id=&#34;web-console&#34;&gt;Web Console&lt;/h2&gt;
&lt;p&gt;透過 oc 取得 Web console 的 route URL:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ oc -n openshift-console get route console -o&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;jsonpath&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;.spec.host&lt;span class=&#34;o&#34;&gt;}{&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\n&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
console-openshift-console.apps.lab.yiylin.internal
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;取得 OpenShift 的 &lt;code&gt;kubeadmin&lt;/code&gt; 密碼:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ cat &lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/ignition/auth/kubeadmin-password
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;figure 
	&gt;
	&lt;a href=&#34;https://i.imgur.com/7ykeVUc.png&#34; &gt;
		&lt;img src=&#34;https://i.imgur.com/7ykeVUc.png&#34;
			
			
			
			loading=&#34;lazy&#34;
			&gt;
	&lt;/a&gt;
	
&lt;/figure&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&#34;terminal-login&#34;&gt;Terminal Login&lt;/h2&gt;
&lt;p&gt;開啟一個新的 Terminal，在 bastion 節點配置 &lt;code&gt;KUBECONFIG&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ &lt;span class=&#34;nb&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;KUBECONFIG&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$HOME&lt;/span&gt;/ocp4/kubeconfig
$ oc get no
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;references&#34;&gt;References&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://github.com/openshift/machine-config-operator/blob/master/docs/custom-pools.md&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://github.com/openshift/machine-config-operator/blob/master/docs/custom-pools.md&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://gist.github.com/kairen/894348c6281f33a981b528e69c3d06bf&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://gist.github.com/kairen/894348c6281f33a981b528e69c3d06bf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_vsphere/installing-restricted-networks-vsphere.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://docs.openshift.com/container-platform/4.8/installing/installing_vsphere/installing-restricted-networks-vsphere.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-bind&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Networking Guide -  BIND (Berkeley Internet Name Domain)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://docs.openshift.com/container-platform/4.8/installing/installing_bare_metal_ipi/ipi-install-prerequisites.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;參考 IPI Prerequisites&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        
    </channel>
</rss>
