<!doctype html><html lang=zh-tw dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本篇文章主要分享，提供在 OpenShift Container Platform 中透過 Route Sharding，以叢集角度為特定目的創建多個 Route，像是在不同的網段上公開不同的 Router，讓內部和外部署用者訪問不同的 Router，將限制使用者於DMZ區域，無法訪問或直接使用其他叢集區域中的資源，直接保護這些節點及組件來提高安全性。"><title>Deep dive - OpenShift 叢集節點跨網段架構規劃</title>
<link rel=canonical href=https://blog.yylin.io/openshift/security-zones/>
<link rel=stylesheet href=/scss/style.min.5dfb59e7e9320a8eb7995abb74271d0b47aa7bd7423004549c2964fd78196c75.css><meta property="og:title" content="Deep dive - OpenShift 叢集節點跨網段架構規劃">
<meta property="og:description" content="本篇文章主要分享，提供在 OpenShift Container Platform 中透過 Route Sharding，以叢集角度為特定目的創建多個 Route，像是在不同的網段上公開不同的 Router，讓內部和外部署用者訪問不同的 Router，將限制使用者於DMZ區域，無法訪問或直接使用其他叢集區域中的資源，直接保護這些節點及組件來提高安全性。">
<meta property="og:url" content="https://blog.yylin.io/openshift/security-zones/">
<meta property="og:site_name" content="Frank's Notes">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="OpenShift"><meta property="article:published_time" content="2022-09-27T12:00:40+08:00"><meta property="article:modified_time" content="2022-09-27T12:00:40+08:00">
<meta name=twitter:title content="Deep dive - OpenShift 叢集節點跨網段架構規劃">
<meta name=twitter:description content="本篇文章主要分享，提供在 OpenShift Container Platform 中透過 Route Sharding，以叢集角度為特定目的創建多個 Route，像是在不同的網段上公開不同的 Router，讓內部和外部署用者訪問不同的 Router，將限制使用者於DMZ區域，無法訪問或直接使用其他叢集區域中的資源，直接保護這些節點及組件來提高安全性。">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-60ZBHV66GB"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-60ZBHV66GB',{anonymize_ip:!1})}</script>
<style>h1{letter-spacing:6px}</style>
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<div class=site-meta>
<h1 class=site-name><a href=/>Frank's Notes</a></h1>
<h2 class=site-description>拆解|筆記|復盤</h2>
</div>
</header><ol class=menu id=main-menu>
<li>
<a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span>
</a>
</li>
<li>
<a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span>
</a>
</li>
<li>
<a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span>
</a>
</li>
<li>
<a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span>
</a>
</li>
<li>
<a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>夜晚模式</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/openshift/>
OpenShift
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/openshift/security-zones/>Deep dive - OpenShift 叢集節點跨網段架構規劃</a>
</h2>
<h3 class=article-subtitle>
本篇文章主要分享，提供在 OpenShift Container Platform 中透過 Route Sharding，以叢集角度為特定目的創建多個 Route，像是在不同的網段上公開不同的 Router，讓內部和外部署用者訪問不同的 Router，將限制使用者於DMZ區域，無法訪問或直接使用其他叢集區域中的資源，直接保護這些節點及組件來提高安全性。
</h3>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 27, 2022</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
閱讀時間: 4 分鐘
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=概述-為什麼有這樣需求>/概述/ 為什麼有這樣需求？</h2>
<p>近期剛好接觸客戶需求，希望能透過「單一叢集OpenSihft 運作於跨網段區域」上架構需求，希望有基於能限制不同角色，訪問流量進入 OpenShift 叢集只允許使用特定功能，包含以下需求：</p>
<ol>
<li>能限制只有叢集管理人員/開發團隊，能直接存取操作 OpenShift 叢集於內部網路中，因此叢集對應的內部服務、API、儲存等，能獲得更多更安全性。</li>
<li>將提供外部應用程式/服務，隔離於對外 Security Zones 區域，並限制只允許特定的 Router 使用某些特定功能(例如：單純網站服務運行, APP 後端服務)等。</li>
</ol>
<blockquote>
<p>主要目的：希望透過 Shard Route 負責，在不同 IP 地址，讓內部和外部使用者訪問不同的 Router 以達到 DMZ 與 OCP 訪問限制，來減少成本下能更加提升叢集運作安全性。</p>
</blockquote>
<p>補充 - 更多場景情境，歡迎大家可以參考 Luis Javier Arizmendi Alonso 分享針對 OpenShift 於 Security Zones 系列文章 - <a class=link href=https://itnext.io/security-zones-in-openshift-worker-nodes-part-i-introduction-4f85762962d7 target=_blank rel=noopener>Security Zones in OpenShift worker nodes</a></p>
<h2 id=探討--相關架構考量>/探討/ 相關架構考量</h2>
<p>先探討結論，為什麼不採用「針對 Security Zones 進行實體隔離」來達到企業內部制定相對安全標準和法規，例如直接在 DMZ 區域多部署一座 OpenShift 叢集提供對外服務(參考補充)，更直接保護叢集運行產品的應用及服務更能確保安全性，其實重點包含<code>成本考量</code>還有 <code>OpenShift維護成本</code>高，可能企業內部需要更多維運人員來管理不同 OpenShift 叢集上版流程、應用程式、API及相關服務配置管理等，都是總總問題。</p>
<h3 id=補充---透過實體隔離方案->/補充 - 透過<code>實體隔離方案</code> /</h3>
<ul>
<li>有助於證明 Data Center 符合安全標準和法規</li>
<li>更保護叢集 API 和 DMZ 中，不會暴露給外部 Internet</li>
<li>OpenShift 維護成本高</li>
</ul>
<p><img src=/openshift/security-zones/img/01.png width=516 height=593 srcset="/openshift/security-zones/img/01_hud6af0256d637efc1e9fc480ef98eae1a_45911_480x0_resize_box_3.png 480w, /openshift/security-zones/img/01_hud6af0256d637efc1e9fc480ef98eae1a_45911_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=87 data-flex-basis=208px></p>
<p>所以或許另一種選擇，透過有一個大型的 OpenShift「單一叢集跨網段架構」能使更容易維運管理及同時達到提高安全性架構，就是此次架構分享重點。</p>
<blockquote>
<p>這邊還是一個重點，取決於你對於當前環境規劃與架構設計需求而做選擇</p>
</blockquote>
<h3 id=以下針對本文主要概述-單一叢集跨網段架構-架構圖做細部探討>以下針對本文主要概述「 <code>單一叢集跨網段架構</code> 」架構圖做細部探討：</h3>
<p><img src=/openshift/security-zones/img/02.png width=517 height=496 srcset="/openshift/security-zones/img/02_hub4534f67c6d5a4f6e58796ce01e74a58_78220_480x0_resize_box_3.png 480w, /openshift/security-zones/img/02_hub4534f67c6d5a4f6e58796ce01e74a58_78220_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=104 data-flex-basis=250px></p>
<ul>
<li>每座 OpenShift 叢集都應被視為僅在內部管理，而不是暴露於外部 Internet</li>
<li>若劃分 Infra Nodes 創建在不同的 Zone 區域中，每個區域中提供使用者運行 Ingress 等應用及 Services 服務的 Pod</li>
<li>將限制使用者無法訪問或直接使用其他叢集區域中的資源，直接保護這些節點及組件。
<ul>
<li>例如：Master API, Logging, Metrics, Registry 等應該運行於內部 Internet</li>
</ul>
</li>
<li>針對特定 Zone 區域運行應用，如果有特定服務需求，可以使用 node-selectors 將 Pod 實體隔離到特定 Worker 節點
<ul>
<li>例如：上圖 Pod 跑在特定「藍色節點」上，只能單獨在藍色區域節點運行 Pod</li>
</ul>
</li>
</ul>
<h2 id=單一叢集-opensihft-運作於跨網段區域>單一叢集 OpenSihft 運作於跨網段區域</h2>
<p>下圖 - 為-驗證規劃 OpenShift 示意圖：</p>
<p><img src=/openshift/security-zones/img/03.png width=905 height=764 srcset="/openshift/security-zones/img/03_hu4c832c4ecd980ff8588f2e4451d8a24c_86575_480x0_resize_box_3.png 480w, /openshift/security-zones/img/03_hu4c832c4ecd980ff8588f2e4451d8a24c_86575_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=118 data-flex-basis=284px></p>
<h2 id=操作步驟>操作步驟</h2>
<ol>
<li>需創建對外服務的 Ingress Controller 要如何配置規範</li>
</ol>
<ul>
<li>
<p>Infra 節點依據網段區域定義標籤</p>
</li>
<li>
<p>DNS 配置對外 External Service 使用的 WildCard</p>
</li>
<li>
<p>創建 Ingress Controller 指派為外部應用使用</p>
</li>
<li>
<p>設置 route 透過標籤指派運行於對外區域的 infra 節點</p>
<p><img src=/openshift/security-zones/img/05.png width=1241 height=576 srcset="/openshift/security-zones/img/05_hu81aaa288d3453154f57d3f8367842c22_154219_480x0_resize_box_3.png 480w, /openshift/security-zones/img/05_hu81aaa288d3453154f57d3f8367842c22_154219_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=215 data-flex-basis=517px></p>
</li>
<li>
<p>指定配置 Hostname 並給外部Service 解析
<img src=/openshift/security-zones/img/06.png width=1115 height=513 srcset="/openshift/security-zones/img/06_hu9a0b08036f071fc3bfebf1085b32fc7b_99190_480x0_resize_box_3.png 480w, /openshift/security-zones/img/06_hu9a0b08036f071fc3bfebf1085b32fc7b_99190_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=217 data-flex-basis=521px></p>
</li>
</ul>
<ol start=2>
<li>服務與應用程式部署完成後，對外的 Router 要定義經過哪一個 Ingress 節點去提供服務</li>
</ol>
<ul>
<li>
<p>修改預設 Ingress Controller - default 配置不讓其他 Service 服務進入</p>
</li>
<li>
<p>新增對外服務的 Ingress Controller - service 如何配置</p>
<p><img src=/openshift/security-zones/img/07.png width=1229 height=508 srcset="/openshift/security-zones/img/07_huebd1e6a12edf16bac67160f0ad8bb7bc_114486_480x0_resize_box_3.png 480w, /openshift/security-zones/img/07_huebd1e6a12edf16bac67160f0ad8bb7bc_114486_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=241 data-flex-basis=580px></p>
</li>
</ul>
<h3 id=1-dns-配置對外-external-service-使用的-wildcard>1. DNS 配置對外 External Service 使用的 WildCard</h3>
<div class=table-wrapper><table>
<thead>
<tr>
<th>Usage</th>
<th>FQDN</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes API</td>
<td>api.&lt;cluster_name>.&lt;base_domain></td>
</tr>
<tr>
<td>Internal API</td>
<td>api-int.&lt;cluster_name>.&lt;base_domain></td>
</tr>
<tr>
<td>Ingress route</td>
<td>*.apps.&lt;cluster_name>.&lt;base_domain></td>
</tr>
<tr>
<td>Application, External Service</td>
<td>*.service.&lt;cluster_name>.&lt;base_domain></td>
</tr>
</tbody>
</table></div>
<h3 id=2-將-router-固定到-infra-node>2. 將 Router 固定到 Infra Node</h3>
<ul>
<li>將 Infra Node 依據服務提供區 Zone 1, Zone 2，指定標籤 (範例配置, region=8, region=10)</li>
<li>在 IngressController 對象的 matchLabels 中指定 Label 設置為對應 Infra Node</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc label nodes &lt;INFRA_NODE&gt; region=8
$ oc patch ingresscontroller/default -n  openshift-ingress-operator  --type=merge -p &#39;{&#34;spec&#34;:{&#34;nodePlacement&#34;: {&#34;nodeSelector&#34;: {&#34;matchLabels&#34;: {&#34;region&#34;: &#34;8&#34;}}}}}&#39;


apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name: default
  namespace: openshift-ingress-operator
spec:
  replicas: 3
  nodePlacement:
    nodeSelector:
      matchLabels:
        region: &#34;8&#34;


$ oc label nodes &lt;INFRA_NODE&gt; region=10
</code></pre></td></tr></table>
</div>
</div><ul>
<li>檢查節點 label 狀態</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ oc get node -A --show-labels
NAME                            STATUS   ROLES    AGE   VERSION           LABELS
infra-1.ocp4.lab.example.com    Ready    worker   60d   v1.23.5+3afdacb   <span class=nv>region</span><span class=o>=</span>8, beta.kubernetes.io/arch<span class=o>=</span>amd64,...
infra-2.ocp4.lab.example.com    Ready    worker   60d   v1.23.5+3afdacb   <span class=nv>region</span><span class=o>=</span>8, beta.kubernetes.io/arch<span class=o>=</span>amd64,...
infra-3.ocp4.lab.example.com    Ready    worker   60d   v1.23.5+3afdacb   <span class=nv>region</span><span class=o>=</span>8, beta.kubernetes.io/arch<span class=o>=</span>amd64,...
infra-4.ocp4.lab.example.com    Ready    worker   60d   v1.23.5+3afdacb   <span class=nv>region</span><span class=o>=</span>10, beta.kubernetes.io/arch<span class=o>=</span>amd64,...
infra-5.ocp4.lab.example.com    Ready    worker   60d   v1.23.5+3afdacb   <span class=nv>region</span><span class=o>=</span>10, beta.kubernetes.io/arch<span class=o>=</span>amd64,...
</code></pre></td></tr></table>
</div>
</div><h3 id=3-創建-ingress-controller-指派為外部應用使用>3. 創建 Ingress Controller 指派為外部應用使用</h3>
<ul>
<li>創建命名為 “Service” 的 Ingress Controller(Router) 將允許從外部訪問的應用程式或服務，引流到對應的 Ingress</li>
<li>如下圖 (指定的 Label region: ‘10’ )為對外使用的網域</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ cat ingress-service.yaml 
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name: service
  namespace: openshift-ingress-operator
spec:
  replicas: 2  
  domain: service.ocp4.lab.example.com   
  nodePlacement:
    nodeSelector:
      matchLabels:
        region: &#39;10&#39;
  routeSelector:
    matchExpressions:
      - key: type
        operator: In
        values:
          - service
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>這邊指定對外 External Service 使用的網域</p>
</blockquote>
<ul>
<li>設置 ingress</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc apply -f ingress-service.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id=4-限制對內對外服務-ingress-controller-配置>4. 限制對內對外服務 Ingress Controller 配置</h3>
<p><img src=/openshift/security-zones/img/04.png width=341 height=459 srcset="/openshift/security-zones/img/04_hu4abab21e5dcbbf8538530220842f1a4c_43342_480x0_resize_box_3.png 480w, /openshift/security-zones/img/04_hu4abab21e5dcbbf8538530220842f1a4c_43342_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=74 data-flex-basis=178px></p>
<ul>
<li>修改預設 Ingress Controller - default 配置不讓其他 Service 服務進入</li>
<li>新增對外服務的 Ingress Controller - service 如何配置</li>
</ul>
<blockquote>
<p>設定 Ingress Controller - service 指定 service 服務可以進入</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc edit ingresscontroller service -n openshift-ingress-operator
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name: service
  namespace: openshift-ingress-operator
spec:
  replicas: 2
  domain: service.ocp4.lab.example.com 
  nodePlacement:
    nodeSelector:
      matchLabels:
        region: &#39;10&#39;
  routeSelector:
    matchExpressions:
      - key: type
        operator: In
        values:
        - service
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>檢查 Ingress Controller - default 限制不讓 service 服務進入</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc edit ingresscontroller default -n openshift-ingress-operator 
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name: service
  namespace: openshift-ingress-operator
spec:
  replicas: 3 
  domain: apps.ocp4.lab.example.com 
  nodePlacement:
    nodeSelector:
      matchLabels:
        region: &#34;8&#34;
  routeSelector:
    matchExpressions:
    - key: type
      operator: NotIn
      values:
      - service
</code></pre></td></tr></table>
</div>
</div><h3 id=5-部署應用生成-route-並指定其-hostname和-label-typeservice>5. 部署應用，生成 Route 並指定其 Hostname和 Label (type=service)</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc new-project demo
$ oc new-app rails-postgresql-example
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc get pod -o wide
NAME                                  READY   STATUS      RESTARTS   AGE     IP            NODE                           
postgresql-1-deploy                   0/1     Completed   0          2d20h   10.129.6.16   worker-3.ocp4.lab.example.com 
postgresql-1-hjztg                    1/1     Running     0          2d20h   10.129.4.98   worker-2.ocp4.lab.example.com
rails-postgresql-example-1-build      0/1     Completed   0          2d20h   10.129.4.97   worker-2.ocp4.lab.example.com
rails-postgresql-example-1-deploy     0/1     Completed   0          2d19h   10.129.8.9    infra-1.ocp4.lab.example.com 
rails-postgresql-example-1-f8w4l      1/1     Running     0          2d19h   10.129.3.18   worker-1.ocp4.lab.example.com 
rails-postgresql-example-1-hook-pre   0/1     Completed   0          2d19h   10.129.3.17   worker-1.ocp4.lab.example.com
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在創建 route 的時候需指定 hostname，不可使用預設名稱，此部分跳過說明，可以看到如以下 route domain 為 <code>.service.ocp4.lab.example.com</code> 結尾。</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc get route
NAME                       HOST/PORT                                               PATH   SERVICES            PORT    TERMINATION   WILDCARD
rails-postgresql-example   rails-postgresql-example-demo.service.ocp4.lab.example.com     rails-postgresql-example          &lt;all&gt;      None
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>#指定 label 讓 rails-postgresql-example 的 route 地址與設置解析</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc label route rails-postgresql-example type=service
</code></pre></td></tr></table>
</div>
</div><h3 id=6-訪問-ap-的-route-地址確認狀態可以訪問>6. 訪問 AP 的 Route 地址，確認狀態可以訪問</h3>
<ul>
<li>預設應用及服務走 default 網頁會讀取不到</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc label route rails-postgresql-example type- 
</code></pre></td></tr></table>
</div>
</div><p><img src=/openshift/security-zones/img/08.png width=1127 height=647 srcset="/openshift/security-zones/img/08_huda9aa56bc4effed2df008c35645ed447_142356_480x0_resize_box_3.png 480w, /openshift/security-zones/img/08_huda9aa56bc4effed2df008c35645ed447_142356_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=174 data-flex-basis=418px></p>
<ul>
<li>增加外部服務對應 label (如範例 type=service)</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>$ oc label route rails-postgresql-example type=service
</code></pre></td></tr></table>
</div>
</div><p><img src=/openshift/security-zones/img/09.png width=1187 height=683 srcset="/openshift/security-zones/img/09_hufbd81718645c2c061487964a68caad0a_251451_480x0_resize_box_3.png 480w, /openshift/security-zones/img/09_hufbd81718645c2c061487964a68caad0a_251451_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=173 data-flex-basis=417px></p>
<h2 id=延伸討論>延伸討論</h2>
<ul>
<li>本次無討論 Application, External Service 資源放置問題</li>
</ul>
<blockquote>
<p>是否建議將屬於 DMZ 區的 Pod 放置於屬於 DMZ 上配置的 Worker Node 節點？</p>
</blockquote>
<ul>
<li>因架構規劃，需多新增一個 Ingress 對外提供服務，就有憑證管理需求</li>
</ul>
<blockquote>
<p>此部分要採用 OpenShift 本身簽署的部分還是客戶額外簽署的部分？</p>
</blockquote>
<ul>
<li>DNS 跨網段拆分問題</li>
</ul>
<blockquote>
<p>若各網段有獨立DNS服務器架構情境？</p>
</blockquote>
<h2 id=reference>Reference</h2>
<ul>
<li><a class=link href=https://rcarrata.com/openshift/ocp4_route_sharding/ target=_blank rel=noopener>Deep dive of Route Sharding in OpenShift 4</a></li>
<li><a class=link href=https://itnext.io/security-zones-in-openshift-worker-nodes-part-i-introduction-4f85762962d7 target=_blank rel=noopener>Security Zones in OpenShift worker nodes — Part I — Introduction</a></li>
<li><a class=link href="https://blog.csdn.net/weixin_43902588/article/details/103543191?spm=1001.2014.3001.5502" target=_blank rel=noopener>OpenShift 4 - Ingress、Route與Shard</a></li>
<li><a class=link href=https://docs.openshift.com/container-platform/4.11/networking/configuring_ingress_cluster_traffic/configuring-ingress-cluster-traffic-ingress-controller.html#nw-using-ingress-and-routes_configuring-ingress-cluster-traffic-ingress-controller target=_blank rel=noopener>OCP4.11 - Using Ingress Controllers and routes </a></li>
</ul>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/openshift/>OpenShift</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相關文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/openshift/sno-installer/>
<div class=article-details>
<h2 class=article-title>單節點 OpenShift 部署與應用探討</h2>
</div>
</a>
</article>
<article>
<a href=/openshift/gpu-operator/>
<div class=article-details>
<h2 class=article-title>NVIDIA GPU Operator on OpenShift4</h2>
</div>
</a>
</article>
<article>
<a href=/openshift/mirror-registry-for-ocp4-install/>
<div class=article-details>
<h2 class=article-title>Disconnected Environment - Introducing Mirror Registry for Red Hat OpenShift</h2>
</div>
</a>
</article>
<article>
<a href=/openshift/install-troubleshooting/>
<div class=article-details>
<h2 class=article-title>OpenShift Intsall Troubleshooting Notes</h2>
</div>
</a>
</article>
<article>
<a href=/openshift/ocp4-install/>
<div class=article-details>
<h2 class=article-title>OpenShift 4.8.x UPI install on Bare metal</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2022 -
2024 Frank's Notes
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.10.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目錄</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#概述-為什麼有這樣需求>/概述/ 為什麼有這樣需求？</a></li>
<li><a href=#探討--相關架構考量>/探討/ 相關架構考量</a>
<ul>
<li><a href=#補充---透過實體隔離方案->/補充 - 透過<code>實體隔離方案</code> /</a></li>
<li><a href=#以下針對本文主要概述-單一叢集跨網段架構-架構圖做細部探討>以下針對本文主要概述「 <code>單一叢集跨網段架構</code> 」架構圖做細部探討：</a></li>
</ul>
</li>
<li><a href=#單一叢集-opensihft-運作於跨網段區域>單一叢集 OpenSihft 運作於跨網段區域</a></li>
<li><a href=#操作步驟>操作步驟</a>
<ul>
<li><a href=#1-dns-配置對外-external-service-使用的-wildcard>1. DNS 配置對外 External Service 使用的 WildCard</a></li>
<li><a href=#2-將-router-固定到-infra-node>2. 將 Router 固定到 Infra Node</a></li>
<li><a href=#3-創建-ingress-controller-指派為外部應用使用>3. 創建 Ingress Controller 指派為外部應用使用</a></li>
<li><a href=#4-限制對內對外服務-ingress-controller-配置>4. 限制對內對外服務 Ingress Controller 配置</a></li>
<li><a href=#5-部署應用生成-route-並指定其-hostname和-label-typeservice>5. 部署應用，生成 Route 並指定其 Hostname和 Label (type=service)</a></li>
<li><a href=#6-訪問-ap-的-route-地址確認狀態可以訪問>6. 訪問 AP 的 Route 地址，確認狀態可以訪問</a></li>
</ul>
</li>
<li><a href=#延伸討論>延伸討論</a></li>
<li><a href=#reference>Reference</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>